<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BOQ Converter ‚Äî KD ‚Üí QAR</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;1,600&family=Outfit:wght@300;400;500;600&family=Noto+Kufi+Arabic:wght@300;400;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#F7F4EF;--surface:#FFFFFF;--surface2:#F0EDE6;
  --border:#E2DDD5;--border2:#CCC7BC;
  --text:#1C1814;--text2:#7A7368;--text3:#A89F94;
  --gold:#B8882A;--gold-l:#F5E8C8;--gold-d:#8A6318;
  --teal:#1A7A6E;--teal-l:#D0EDEA;
  --red:#C43A2A;--red-l:#FAE0DC;
  --r:14px;
  --sh:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);
  --sh2:0 2px 8px rgba(0,0,0,.08),0 8px 32px rgba(0,0,0,.08);
  --fbd:'Outfit',sans-serif;--far:'Noto Kufi Arabic',sans-serif;
  --fdp:'Playfair Display',serif;
}
[data-dark]{
  --bg:#111009;--surface:#1A1814;--surface2:#221F19;
  --border:#302C24;--border2:#45403A;
  --text:#F0EBE3;--text2:#8A8378;--text3:#5A5550;
  --gold:#D4A030;--gold-l:#1E1500;--gold-d:#E8B840;
  --teal:#26A090;--teal-l:#041A18;
  --sh:0 1px 3px rgba(0,0,0,.3),0 4px 16px rgba(0,0,0,.3);
  --sh2:0 2px 8px rgba(0,0,0,.4),0 8px 32px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  background:var(--bg);color:var(--text);
  font-family:var(--fbd);font-size:15px;line-height:1.6;
  min-height:100vh;transition:background .35s,color .35s;
  -webkit-font-smoothing:antialiased;
}
[dir=rtl],[dir=rtl] body{font-family:var(--far);}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  opacity:.3;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
}

/* ‚îÄ‚îÄ layout ‚îÄ‚îÄ */
.wrap{
  position:relative;z-index:1;
  width:100%;max-width:680px;
  margin:0 auto;
  padding:24px 16px 60px;
}

/* ‚îÄ‚îÄ header ‚îÄ‚îÄ */
.header{
  display:flex;align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:28px;
}
.brand{display:flex;flex-direction:column;gap:3px;min-width:0;}
.brand-name{
  font-family:var(--fdp);font-size:clamp(20px,5vw,28px);
  line-height:1.1;letter-spacing:-.01em;color:var(--text);
  white-space:nowrap;
}
.brand-name span{color:var(--gold);font-style:italic;}
.brand-tagline{
  font-size:clamp(9px,2.5vw,11.5px);color:var(--text3);
  letter-spacing:.08em;text-transform:uppercase;font-weight:500;
}
.hdr-controls{display:flex;gap:6px;flex-shrink:0;padding-top:2px;}

/* ‚îÄ‚îÄ pill ‚îÄ‚îÄ */
.pill{
  border:1.5px solid var(--border2);background:var(--surface);
  color:var(--text2);padding:5px 12px;border-radius:100px;
  font-size:12px;font-weight:500;cursor:pointer;
  font-family:inherit;transition:all .2s;letter-spacing:.03em;
  white-space:nowrap;
}
.pill:hover{border-color:var(--gold);color:var(--gold);}

/* ‚îÄ‚îÄ card ‚îÄ‚îÄ */
.card{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r);padding:clamp(16px,4vw,28px);
  box-shadow:var(--sh);margin-bottom:14px;
  transition:box-shadow .3s;
}
.card:hover{box-shadow:var(--sh2);}

/* ‚îÄ‚îÄ section label ‚îÄ‚îÄ */
.sec-label{
  font-size:10px;text-transform:uppercase;letter-spacing:.1em;
  color:var(--text3);font-weight:600;margin-bottom:12px;
}

/* ‚îÄ‚îÄ mode grid ‚îÄ‚îÄ */
.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;}
.mode-tile{
  border:2px solid var(--border);border-radius:10px;
  padding:clamp(12px,3vw,18px) clamp(10px,2.5vw,16px);
  cursor:pointer;transition:all .22s;background:var(--surface2);
}
.mode-tile:hover,.mode-tile.on{border-color:var(--gold);background:var(--gold-l);}
.mode-tile.on .tile-icon{opacity:1;}
.tile-icon{
  font-size:clamp(20px,5vw,26px);
  margin-bottom:8px;opacity:.65;transition:opacity .2s;display:block;
}
.tile-name{font-size:clamp(11px,3vw,13px);font-weight:600;color:var(--text);margin-bottom:2px;}
.tile-desc{font-size:clamp(10px,2.5vw,11.5px);color:var(--text2);line-height:1.4;}

/* ‚îÄ‚îÄ rate row ‚îÄ‚îÄ */
.rate-row{
  display:flex;align-items:center;gap:8px;margin-bottom:20px;
  flex-wrap:wrap;
}
.rate-lbl{font-size:12px;color:var(--text2);white-space:nowrap;}
.rate-field{
  flex:1;min-width:80px;
  border:1.5px solid var(--border);background:var(--surface2);
  color:var(--text);padding:9px 12px;border-radius:8px;
  font-size:14px;font-family:inherit;outline:none;
  transition:border-color .2s;
}
.rate-field:focus{border-color:var(--gold);}
.rate-badge{
  background:var(--gold-l);color:var(--gold-d);
  padding:5px 11px;border-radius:7px;font-size:11.5px;font-weight:600;
  white-space:nowrap;border:1px solid rgba(184,136,42,.2);flex-shrink:0;
}

/* ‚îÄ‚îÄ divider ‚îÄ‚îÄ */
.div{height:1px;background:var(--border);margin:18px 0;}

/* ‚îÄ‚îÄ drop zone ‚îÄ‚îÄ */
.drop{
  border:2px dashed var(--border2);border-radius:10px;
  padding:clamp(28px,8vw,44px) clamp(16px,4vw,28px);
  text-align:center;cursor:pointer;
  transition:all .25s;background:var(--surface2);
  position:relative;overflow:hidden;
}
.drop::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at 50% 0%,var(--gold-l),transparent 70%);
  opacity:0;transition:opacity .3s;
}
.drop:hover::before,.drop.drag::before{opacity:1;}
.drop:hover,.drop.drag{border-color:var(--gold);}
.drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.drop-ico{
  font-size:clamp(28px,7vw,36px);margin-bottom:10px;
  opacity:.5;display:block;transition:transform .3s,opacity .3s;
}
.drop:hover .drop-ico{opacity:.8;transform:scale(1.08);}
.drop-txt{font-size:clamp(13px,3.5vw,14.5px);color:var(--text2);margin-bottom:4px;
  position:relative;z-index:1;}
.drop-hint{font-size:clamp(11px,3vw,12px);color:var(--text3);position:relative;z-index:1;}

/* ‚îÄ‚îÄ file pill ‚îÄ‚îÄ */
.file-pill{
  display:flex;align-items:center;gap:8px;margin-top:12px;
  background:var(--teal-l);border:1.5px solid var(--teal);
  border-radius:9px;padding:10px 13px;
}
.fp-name{
  font-size:12.5px;font-weight:500;color:var(--teal);flex:1;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;
}
.fp-size{font-size:11px;color:var(--text2);flex-shrink:0;}
.fp-x{
  font-size:15px;color:var(--text2);cursor:pointer;
  background:none;border:none;font-family:inherit;
  line-height:1;flex-shrink:0;padding:2px;
}
.fp-x:hover{color:var(--red);}

/* ‚îÄ‚îÄ convert button ‚îÄ‚îÄ */
.btn-go{
  width:100%;padding:clamp(13px,3.5vw,15px) 20px;margin-top:18px;
  border:none;border-radius:10px;cursor:pointer;
  background:var(--gold);color:#fff;
  font-size:clamp(14px,4vw,15px);font-weight:600;font-family:inherit;
  letter-spacing:.03em;transition:all .22s;
  display:flex;align-items:center;justify-content:center;gap:10px;
  /* critical for mobile tap */
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.btn-go:hover:not(:disabled){
  background:var(--gold-d);transform:translateY(-1px);
  box-shadow:0 6px 20px rgba(184,136,42,.38);
}
.btn-go:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}

/* ‚îÄ‚îÄ progress card ‚îÄ‚îÄ */
.prog-card{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r);padding:clamp(18px,4vw,28px);
  box-shadow:var(--sh);display:none;
}
.prog-top{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;gap:8px;
}
.prog-label{font-size:clamp(14px,4vw,16px);font-weight:600;}
.prog-pct{
  font-family:var(--fdp);font-size:clamp(28px,8vw,38px);
  color:var(--gold);line-height:1;font-style:italic;flex-shrink:0;
}
.prog-track{
  background:var(--surface2);border-radius:100px;height:8px;
  overflow:hidden;margin-bottom:16px;border:1px solid var(--border);
}
.prog-fill{
  height:100%;
  background:linear-gradient(90deg,var(--gold),var(--gold-d));
  border-radius:100px;transition:width .45s cubic-bezier(.4,0,.2,1);
  position:relative;overflow:hidden;
}
.prog-fill::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
  animation:shimmer 1.5s infinite;
}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}

/* stats ‚Äî 2√ó2 on mobile, 4√ó1 on wider */
.prog-stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(min-width:420px){
  .prog-stats{grid-template-columns:repeat(4,1fr);}
}
.pstat{display:flex;flex-direction:column;gap:2px;}
.pstat-v{
  font-size:clamp(18px,5vw,22px);font-weight:600;
  color:var(--text);font-variant-numeric:tabular-nums;
}
.pstat-l{
  font-size:clamp(9px,2.5vw,10.5px);color:var(--text3);
  text-transform:uppercase;letter-spacing:.06em;
}

/* ‚îÄ‚îÄ done card ‚îÄ‚îÄ */
.done-card{
  background:var(--surface);border:1.5px solid var(--teal);
  border-radius:var(--r);padding:clamp(24px,6vw,40px) clamp(16px,4vw,28px);
  box-shadow:0 4px 28px rgba(26,122,110,.12);
  text-align:center;display:none;
}
.done-ico{
  font-size:clamp(40px,12vw,56px);margin-bottom:14px;display:block;
  animation:pop .5s cubic-bezier(.34,1.56,.64,1) forwards;
}
@keyframes pop{from{transform:scale(.4);opacity:0}to{transform:scale(1);opacity:1}}
.done-title{
  font-family:var(--fdp);font-size:clamp(20px,5vw,26px);
  color:var(--teal);margin-bottom:6px;
}
.done-meta{font-size:clamp(11px,3vw,13px);color:var(--text2);margin-bottom:24px;}
.btn-dl{
  display:inline-flex;align-items:center;gap:8px;
  background:var(--teal);color:#fff;
  padding:clamp(11px,3vw,14px) clamp(20px,5vw,36px);
  border-radius:10px;font-size:clamp(13px,3.5vw,15px);font-weight:600;
  font-family:inherit;border:none;cursor:pointer;transition:all .22s;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
  max-width:100%;
}
.btn-dl:hover{background:#0d5e54;transform:translateY(-1px);
  box-shadow:0 6px 20px rgba(26,122,110,.38);}
.btn-again{
  display:inline-block;margin-top:16px;font-size:12px;
  color:var(--text2);cursor:pointer;background:none;border:none;
  font-family:inherit;text-decoration:underline;text-underline-offset:3px;
  -webkit-tap-highlight-color:transparent;
}
.btn-again:hover{color:var(--text);}

/* ‚îÄ‚îÄ error ‚îÄ‚îÄ */
.err{
  background:var(--red-l);border:1.5px solid var(--red);
  border-radius:9px;padding:12px 16px;margin-bottom:14px;
  font-size:13px;color:var(--red);display:none;
}

/* ‚îÄ‚îÄ footer ‚îÄ‚îÄ */
.footer{
  text-align:center;font-size:11px;color:var(--text3);
  margin-top:40px;letter-spacing:.06em;
}

/* ‚îÄ‚îÄ animations ‚îÄ‚îÄ */
@keyframes spin{to{transform:rotate(360deg)}}
.spin{
  width:16px;height:16px;border:2.5px solid rgba(255,255,255,.35);
  border-top-color:#fff;border-radius:50%;animation:spin .75s linear infinite;
}
@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.fu{animation:fu .4s ease forwards;}

/* ‚îÄ‚îÄ tablet+ ‚îÄ‚îÄ */
@media(min-width:600px){
  .wrap{padding:36px 24px 80px;}
  .header{margin-bottom:40px;}
}
</style>
</head>
<body>
<div class="wrap">

  <header class="header">
    <div class="brand">
      <div class="brand-name" id="j-brand">BOQ <span>Converter</span></div>
      <div class="brand-tagline" id="j-tag">Kuwait Dinar ‚Üí Qatari Riyal</div>
    </div>
    <div class="hdr-controls">
      <button class="pill" id="j-lang" onclick="toggleLang()">ÿπÿ±ÿ®Ÿä</button>
      <button class="pill" id="j-theme" onclick="toggleDark()">üåô</button>
    </div>
  </header>

  <div class="err" id="j-err"></div>

  <div id="j-form">
    <div class="card fu">
      <div class="sec-label" id="j-lbl-mode">Output Format</div>
      <div class="mode-grid">
        <div class="mode-tile on" id="tile-pdf" onclick="setMode('pdf')">
          <span class="tile-icon">üìÑ</span>
          <div class="tile-name">PDF ‚Üí PDF</div>
          <div class="tile-desc" id="j-desc-pdf">Preserve original layout ¬∑ Replace values in place</div>
        </div>
        <div class="mode-tile" id="tile-xl" onclick="setMode('xlsx')">
          <span class="tile-icon">üìä</span>
          <div class="tile-name">PDF ‚Üí Excel</div>
          <div class="tile-desc" id="j-desc-xl">Extract to formatted spreadsheet ¬∑ One sheet per page</div>
        </div>
      </div>

      <div class="sec-label" id="j-lbl-rate">Exchange Rate</div>
      <div class="rate-row">
        <span class="rate-lbl" id="j-lbl-1kd">1 KD =</span>
        <input class="rate-field" id="j-rate" type="number"
               value="11.88" min="0.001" step="0.001" inputmode="decimal"/>
        <div class="rate-badge"><span id="j-rate-v">11.88</span> QAR</div>
      </div>

      <div class="div"></div>

      <div class="sec-label" id="j-lbl-file">Source File</div>
      <div class="drop" id="j-drop"
           ondragover="event.preventDefault();this.classList.add('drag')"
           ondragleave="this.classList.remove('drag')"
           ondrop="onDrop(event)">
        <input type="file" accept=".pdf" onchange="onPick(event)"/>
        <span class="drop-ico">üìÇ</span>
        <div class="drop-txt" id="j-drop-txt">Tap to browse or drop PDF here</div>
        <div class="drop-hint" id="j-drop-hint">Bill of Quantities / BOQ PDF files</div>
      </div>
      <div id="j-fp"></div>

      <button class="btn-go" id="j-go" onclick="go()" disabled>
        <span id="j-go-txt">Convert</span>
      </button>
    </div>
  </div>

  <div class="prog-card fu" id="j-prog">
    <div class="prog-top">
      <div class="prog-label" id="j-prog-lbl">Converting‚Ä¶</div>
      <div class="prog-pct" id="j-pct">0%</div>
    </div>
    <div class="prog-track"><div class="prog-fill" id="j-bar" style="width:0%"></div></div>
    <div class="prog-stats">
      <div class="pstat">
        <div class="pstat-v" id="j-s-page">0</div>
        <div class="pstat-l" id="j-l-page">Page</div>
      </div>
      <div class="pstat">
        <div class="pstat-v" id="j-s-total">‚Äî</div>
        <div class="pstat-l" id="j-l-total">Total</div>
      </div>
      <div class="pstat">
        <div class="pstat-v" id="j-s-rep">‚Äî</div>
        <div class="pstat-l" id="j-l-rep">Converted</div>
      </div>
      <div class="pstat">
        <div class="pstat-v" id="j-s-time">0s</div>
        <div class="pstat-l" id="j-l-time">Elapsed</div>
      </div>
    </div>
  </div>

  <div class="done-card fu" id="j-done">
    <span class="done-ico">‚úÖ</span>
    <div class="done-title" id="j-done-title">Conversion Complete!</div>
    <div class="done-meta" id="j-done-meta"></div>
    <button class="btn-dl" onclick="dl()">
      ‚¨á&nbsp;<span id="j-dl-txt">Download File</span>
    </button>
    <br/>
    <button class="btn-again" onclick="reset()" id="j-again">Convert another file ‚Üí</button>
  </div>

  <div class="footer" id="j-foot">BOQ Converter</div>
</div>

<script>
const T={
  en:{
    brand:'BOQ <span>Converter</span>',tag:'Kuwait Dinar ‚Üí Qatari Riyal',lang:'ÿπÿ±ÿ®Ÿä',
    lblMode:'Output Format',lblRate:'Exchange Rate',lblFile:'Source File',
    descPdf:'Preserve original layout ¬∑ Replace values in place',
    descXl:'Extract to formatted spreadsheet ¬∑ One sheet per page',
    lbl1kd:'1 KD =',dropTxt:'Tap to browse or drop PDF here',
    dropHint:'Bill of Quantities / BOQ PDF files',
    go:'Convert',converting:'Converting‚Ä¶',
    pg:'Page',total:'Total',converted:'Converted',elapsed:'Elapsed',
    doneTitle:'Conversion Complete!',dl:'Download File',
    again:'Convert another file ‚Üí',foot:'BOQ Converter',
  },
  ar:{
    brand:'ŸÖÿ≠ŸàŸëŸÑ <span>ÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÉŸÖŸäÿßÿ™</span>',tag:'ÿØŸäŸÜÿßÿ± ŸÉŸàŸäÿ™Ÿä ‚Üí ÿ±ŸäÿßŸÑ ŸÇÿ∑ÿ±Ÿä',lang:'EN',
    lblMode:'ÿµŸäÿ∫ÿ© ÿßŸÑÿÆÿ±ÿ¨',lblRate:'ŸÖÿπÿØŸÑ ÿßŸÑÿµÿ±ŸÅ',lblFile:'ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿµÿØÿ±',
    descPdf:'ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ£ÿµŸÑŸä ŸÖÿπ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÇŸäŸÖ',
    descXl:'ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ•ŸÑŸâ ÿ¨ÿØŸàŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜÿ≥ŸëŸÇ ¬∑ ÿ¥Ÿäÿ™ ŸÑŸÉŸÑ ÿµŸÅÿ≠ÿ©',
    lbl1kd:'1 ÿØ.ŸÉ =',dropTxt:'ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿµŸÅÿ≠ ÿ£Ÿà ÿ£ÿ≥ŸÇÿ∑ ŸÖŸÑŸÅ PDF ŸáŸÜÿß',
    dropHint:'ŸÖŸÑŸÅÿßÿ™ ÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÉŸÖŸäÿßÿ™ BOQ',
    go:'ÿ™ÿ≠ŸàŸäŸÑ',converting:'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ‚Ä¶',
    pg:'ÿßŸÑÿµŸÅÿ≠ÿ©',total:'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä',converted:'ÿßŸÑŸÖÿ≠ŸàŸëŸÑÿ©',elapsed:'ÿßŸÑŸàŸÇÿ™',
    doneTitle:'ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ!',dl:'ÿ™ŸÜÿ≤ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ',
    again:'ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÑŸÅ ÿ¢ÿÆÿ± ‚Üí',foot:'ŸÖÿ≠ŸàŸëŸÑ ÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÉŸÖŸäÿßÿ™',
  }
};
let lang='en',dark=false,mode='pdf',file=null,jobId=null,t0=null,timer=null;

function setText(id,html){const el=document.getElementById(id);if(el)el.innerHTML=html;}
function applyLang(){
  const t=T[lang],isAr=lang==='ar';
  document.documentElement.setAttribute('dir',isAr?'rtl':'ltr');
  Object.entries({
    'j-brand':t.brand,'j-tag':t.tag,'j-lang':t.lang,
    'j-lbl-mode':t.lblMode,'j-lbl-rate':t.lblRate,'j-lbl-file':t.lblFile,
    'j-desc-pdf':t.descPdf,'j-desc-xl':t.descXl,'j-lbl-1kd':t.lbl1kd,
    'j-drop-txt':t.dropTxt,'j-drop-hint':t.dropHint,'j-go-txt':t.go,
    'j-prog-lbl':t.converting,'j-l-page':t.pg,'j-l-total':t.total,
    'j-l-rep':t.converted,'j-l-time':t.elapsed,'j-done-title':t.doneTitle,
    'j-dl-txt':t.dl,'j-again':t.again,'j-foot':t.foot
  }).forEach(([id,v])=>setText(id,v));
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLang();}
function toggleDark(){
  dark=!dark;
  document.documentElement.toggleAttribute('data-dark',dark);
  document.getElementById('j-theme').textContent=dark?'‚òÄÔ∏è':'üåô';
}
function setMode(m){
  mode=m;
  document.getElementById('tile-pdf').classList.toggle('on',m==='pdf');
  document.getElementById('tile-xl').classList.toggle('on',m==='xlsx');
}
document.getElementById('j-rate').addEventListener('input',function(){
  document.getElementById('j-rate-v').textContent=this.value||'0';
});
function onPick(e){if(e.target.files[0])bindFile(e.target.files[0]);}
function onDrop(e){
  e.preventDefault();
  document.getElementById('j-drop').classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f&&f.name.endsWith('.pdf'))bindFile(f);
}
function bindFile(f){
  file=f;
  const mb=(f.size/1048576).toFixed(2);
  document.getElementById('j-fp').innerHTML=
    `<div class="file-pill"><span>üìÑ</span>
     <span class="fp-name">${f.name}</span>
     <span class="fp-size">${mb} MB</span>
     <button class="fp-x" onclick="clearFile()">‚úï</button></div>`;
  document.getElementById('j-go').disabled=false;
}
function clearFile(){
  file=null;
  document.getElementById('j-fp').innerHTML='';
  document.getElementById('j-go').disabled=true;
}
async function go(){
  if(!file)return;
  const rate=document.getElementById('j-rate').value||'11.9';
  const fd=new FormData();
  fd.append('file',file);fd.append('mode',mode);fd.append('rate',rate);
  document.getElementById('j-form').style.display='none';
  document.getElementById('j-err').style.display='none';
  const pg=document.getElementById('j-prog');
  pg.style.display='block';pg.style.animation='fu .4s ease forwards';
  t0=Date.now();
  timer=setInterval(()=>{
    document.getElementById('j-s-time').textContent=
      ((Date.now()-t0)/1000).toFixed(0)+'s';
  },500);
  const res=await fetch('/upload',{method:'POST',body:fd});
  const {job_id}=await res.json();
  jobId=job_id;
  const es=new EventSource(`/progress/${job_id}`);
  es.onmessage=ev=>{
    const d=JSON.parse(ev.data),p=d.progress||0;
    document.getElementById('j-pct').textContent=p+'%';
    document.getElementById('j-bar').style.width=p+'%';
    if(d.page) document.getElementById('j-s-page').textContent=d.page;
    if(d.pages)document.getElementById('j-s-total').textContent=d.pages;
    if(d.replaced!=null)
      document.getElementById('j-s-rep').textContent=(d.replaced||0).toLocaleString();
    if(d.status==='done'||d.done){es.close();clearInterval(timer);done(d);}
    if(d.status==='error'){es.close();clearInterval(timer);showErr(d.error||'Unknown error');}
  };
}
function done(d){
  document.getElementById('j-prog').style.display='none';
  const dc=document.getElementById('j-done');
  dc.style.display='block';dc.style.animation='fu .4s ease forwards';
  const sec=((Date.now()-t0)/1000).toFixed(1);
  const rep=d.replaced?` ¬∑ ${d.replaced.toLocaleString()} items`:'';
  document.getElementById('j-done-meta').textContent=`${d.pages||''} pages${rep} ¬∑ ${sec}s`;
}
function dl(){window.location.href=`/download/${jobId}`;}
function showErr(msg){
  document.getElementById('j-prog').style.display='none';
  document.getElementById('j-form').style.display='block';
  const e=document.getElementById('j-err');
  e.textContent='‚ùå  '+msg;e.style.display='block';
}
function reset(){
  document.getElementById('j-done').style.display='none';
  document.getElementById('j-err').style.display='none';
  document.getElementById('j-form').style.display='block';
  clearFile();
  ['j-bar','j-pct','j-s-page','j-s-total','j-s-rep','j-s-time'].forEach(id=>{
    const el=document.getElementById(id);
    if(id==='j-bar')el.style.width='0%';
    else if(id==='j-pct')el.textContent='0%';
    else if(id==='j-s-page'||id==='j-s-time')el.textContent=id==='j-s-time'?'0s':'0';
    else el.textContent='‚Äî';
  });
  file=null;jobId=null;
}
</script>
</body>
</html>